---
title: "Utah Invert Data Analysis"
author: "Gordon Gianniny"
date: "2023-05-18"
output: html_document
---

```{r, include = F}
#Loading packages:

library(tidyverse) #For data wrangling
library(lubridate) #For working with dates
library(ggplot2) #Plotting
library(RColorBrewer)
library(patchwork)
library(stringr)
library(vegan)
library(broom)
library(sp)
library(maps) #mapping with ggplot2
library(ggmap) #for mapping w/google map basemaps
library(scales)
library(ggpp)

#Setting up ggmap API key: NOTE - for the map figures to work, you'll need to set up a Google Maps Platform Console Account at
#https://cloud.google.com/maps-platform/, create an API key, and store it in your .Renviron file as "GOOGLEMAPS_API_KEY". 

maps_api_key <- Sys.getenv("GOOGLEMAPS_API_KEY")
register_google(key = maps_api_key)
```

## Overview

This document carries out all analysis for the Utah Aquatic Insect Decline project. Input files are: 

1. **longterm_site_richness.csv**: yearly average richness and abundance data for each site with at least 4 years of data (n = 142 sites)

2. **longterm_comid_richness.csv**: yearly average richness and abundance data for each COMID segment with at least 4 years of data (n = 211 COMIDs)

3. **taxa_densities.csv**: abundance and density info for each taxa in each sample (pre-richness calculations) - used for investigating specific taxa of interest. 

Sections are: 

1. Initial data visualizations & basic analysis

* By Site: Checking distribution, examining trends in richness & density over time (site-by-site & overall) 
    
* By COMID: Checking distribution, examining trends in richness & density over time (site-by-site & overall)

2. Taxa of interest

* Pteronarcys californica
    
* Zapada

3. Effects of sampling design (lab split, field split, area sampled) on total sample density

Read in overall datafile: 

```{r}
taxa_densities <-read.csv("cleaned_data/cleaned_full.csv")%>%
  mutate(sampleDate =ymd(sampleDate))
```

## I. Site-by-site data visualizations & Basic LM's

First, extract all sites with >4 years of data: 

```{r}
site_inverts <- taxa_densities %>%
  group_by(siteId)%>%
  mutate(n_yrs = length(unique(yr)))%>%
  ungroup()%>%
  filter(n_yrs>4)
```

#### i. Checking distributions: 

Richness:

```{r}
ggplot(site_inverts, aes(x = richness))+
  geom_histogram(fill = "Grey", color = "Black", bins = 30)+
  theme_classic()+
  labs(x = "Mean Richness", y = "Count")
```

Data are fairly normally distributed, maybe slightly bimodal. 

Density:

```{r}
ggplot(site_inverts, aes(x = tot_dens))+
  geom_histogram(fill = "Grey", color = "Black", bins = 70)+
  theme_classic()+
  labs(x = "Total Density", y = "Count")
```

Strongly left-skewed - try a log transform:

```{r}
ggplot(site_inverts, aes(x = log10(tot_dens)))+
  geom_histogram(fill = "Grey", color = "Black", bins = 70)+
  theme_classic()+
  labs(x = "log10(Mean Total Density)", y = "Count")
```

Better, still slightly skewed - will use log transform for all density plots for now. 

#### ii. Richness over time: 

Visualization:

```{r, warning=F}
site.trends <- ggplot(site_inverts, aes(y = richness, x = yr, color = factor(siteId)))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5)+
  theme_classic()+
  facet_wrap(~factor(siteId), scales = "free")+
  theme(legend.position = "none", 
        strip.text = element_blank(),
        strip.background = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs(x = "Year", 
       y = "Richness")
site.trends
```

A few initial observations: 

  * No consistent trend across all sites - some look flat, some increase, some decrease. 
  
  * Seems like most sites with longer-term data (more points) generally have increasing trends. 
  
  * Very clear trends (+ or -) at some sites, others are more scattered. 
  
  * Would be cool to see if there's some other variable (location, elevation, land use, etc) that explains different trends @ different sites (i.e. why some are increasing, others are decreasing)


Save: 

```{r}
ggsave("plots/site_richness_trends.jpg", site.trends, device = "jpeg", height = 8.5, width = 8.5, units = "in", dpi = "retina")
```

Same visualization as above, but color coded by elevation:

```{r, warning=F}
site.elev.trends <- ggplot(site_inverts, aes(y = richness, x = yr, color = elev_m))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5)+
  theme_classic()+
  facet_wrap(~factor(elev_m), scales = "free")+
  theme(legend.position = "bottom", 
        strip.text = element_blank(),
        strip.background = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.text = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Year", 
       y = "Richness", color = "Elevation, m")
site.elev.trends
```

Doesn't seem to be any consistent pattern across elevations - have both increasing and decreasing trends at all elevations. 


#### iii. Density over time:

Visualization (color coded & sorted by elevation):

```{r, warning=F}
site.elev.dens <- ggplot(site_inverts, aes(y = log10(tot_dens), x = yr, color = elev_m))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5)+
  theme_classic()+
  facet_wrap(~factor(elev_m), scales = "free")+
  theme(legend.position = "bottom", 
        strip.text = element_blank(),
        strip.background = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.text = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Year",
       y = "log10(Total Density)", color = "Elevation, m")
site.elev.dens
```

Similar to richness - some sites increasing, others decreasing. No obvious/consistent patterns across elevations. 


##II. State-wide trends in richness and density:

First, read in statewide average richness and density data: 

```{r}
statewide <- read.csv("cleaned_data/statewide_cleaned.csv")%>%
  mutate(sampleDate = ymd(sampleDate))%>%
  select(!X)
head(statewide)
```

Check distribution of data: 

```{r}
#data re-organization:
hist_dat <- statewide %>%
  pivot_longer(!c(sampleId:band_code), names_to = "type", values_to = "value")%>%
  mutate(logtrans = log10(value))

ggplot(hist_dat, aes(x = value))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()

ggplot(hist_dat, aes(x = logtrans))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()+
  labs(x = "log10(value)")
```

Richness is ok without log transform; density should be log transformed. Non-insect richness probably doesn't have enough data to use. 

#### i. State-wide richness and density: 

Extract state-wide data; nest by type:

```{r}
statewide_filter <- hist_dat%>%
  filter(type == "richness"|type == "tot_dens")%>%
  mutate(transform = ifelse(type == "richness", value, log10(value)), 
         transform_name = ifelse(type == "richness", "Richness", "log10(Total sample density)"))
statewide_nest <- statewide_filter%>%
  nest(data = -type)
```

Basic LM testing for trends in state-wide richness: 

```{r}
statewide.lms<- statewide_nest %>%
  mutate(model = purrr::map(data, ~lm(transform~yr, data =.)%>%
                              tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
statewide.lms
```

Significant increase in richness over time; significant decline in density over time. 

Add p-values and plot:

```{r}
statewide_pv <- merge(statewide_filter, select(statewide.lms, type, p.value))

statewide.analyses <- ggplot(statewide_pv, aes(y = transform, x = sampleDate))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "darkgrey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste("P = ", round(p.value, 2), sep = "")), hjust = 1)+
  theme_classic()+
  labs(x = "Sample Date", 
       y = "Value")+
  facet_wrap(~transform_name, scales = "free_y")+
  theme(axis.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10))
statewide.analyses
```

Save plot: 

```{r}
ggsave("plots/statewide_analyses.pdf", statewide.analyses, device = "pdf", units = "in", dpi = "retina", height = 5, width = 6.5)
```

#### ii. Insect vs. non-insect richness and density

Data prep: 

```{r}
insect_noninsect <- hist_dat %>%
  filter(!type == "richness", !type == "tot_dens")%>%
  mutate(transform = case_when(type == "insect_richness"~value, 
                               type == "insect_dens"~log10(value), 
                               type == "noninsect_richness"~value, 
                               type == "noninsect_dens"~log10(value)
                               ), 
         transform_name = case_when(type == "insect_richness"~"Insect richness", 
                               type == "insect_dens"~"log10(Insect density)", 
                               type == "noninsect_richness"~"Non-insect richness", 
                               type == "noninsect_dens"~"log10(Non-insect density)"
         ))%>%
  filter(!value == 0)
```

Nest data by type:

```{r}
insect_nest <- insect_noninsect%>%
  nest(data = -type)
```

Run an LM for each measure: 

```{r}
insect.noninsect.lms <- insect_nest %>%
  mutate(model = purrr::map(data, ~lm(transform~yr, data =.)%>%
                              tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
insect.noninsect.lms
```

Add p-values and plot: 

```{r}
insect_pv <- merge(insect_noninsect, select(insect.noninsect.lms, type, p.value))%>%
  mutate(transform_name = factor(transform_name, levels = c("Insect richness", "log10(Insect density)", "Non-insect richness", "log10(Non-insect density)")))

insect.analyses <- ggplot(insect_pv, aes(y = transform, x = sampleDate))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "darkgrey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste("P = ", round(p.value, 2), sep = "")), hjust = 1)+
  theme_classic()+
  labs(x = "Sample Date", 
       y = "Value")+
  facet_wrap(~transform_name, scales = "free_y")+
  theme(axis.title = element_text(size = 11, face = "bold"), 
        strip.text = element_text(size = 11, face = "bold"), 
        axis.text = element_text(size = 10))
insect.analyses
```

Save plot: 

```{r}
ggsave("plots/insect_noninsect_analyses.pdf", insect.analyses, device = "pdf", dpi = "retina", units = "in", width = 8, height = 6)
```

## III. Checking taxa of interest

Taxa of interest/concern present in the dataset include: 

* *Pteronarcys californica*

* *Zapada* (esp. high elevation)

* SGCNs from Utah, Idaho, Wyoming, Colorado, Arizona, and Nevada


### A. *Pteronarcys californica*

First, extract all observations of *P. californica* into a new dataframe:

```{r}
p_cal <- taxa_densities%>%
  filter(scientificName == "Pteronarcys californica", 
         !splitCount == 0) #dropping samples where 0 individuals were counted
```

#### i. How is density changing over time across all sites? 

Check distribution: 

```{r}
ggplot(p_cal, aes(x = log10(density)))+
  geom_histogram()
```

Strong left skew, use log transform

Basic LM:

```{r}
pcal.dens.lm <- lm(log10(density)~sampleDate, p_cal)
summary(pcal.dens.lm)
```

Visualization:

```{r}
ggplot(p_cal, aes(x = sampleDate, y = log10(density)))+
  geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(pcal.dens.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(pcal.dens.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "P. Californica Density (individuals/m2)")
```

Non-significant decrease in *P. californica* density over time (ignoring effects of site, etc.)

#### ii. Is prevalence (proportion of sites w/ P. calif. per year) changing over time? 

Calculate # unique sites with *P. calif.* each year: 

```{r}
pCal_yrs <- p_cal%>%
  mutate(yr = year(sampleDate))%>% #create new column with year
  group_by(yr)%>% #group by year
  summarise(density_xbar = mean(density), #calculate mean density, # sites with P. Cal., and total abundance for each year
            n_sites = length(unique(siteId)), 
            tot_abund = sum(splitCount))
```

Add total sites each year and calculate % of sites w/ *P. cali.*: 

```{r}
# Calculate total sites per year:
sites <- taxa_densities%>%
  mutate(yr = year(sampleDate))%>% #Add year colum
  group_by(yr)%>% #group by year
  summarise(total_sites = length(unique(siteId))) #count # unique siteId's per year

#Merge with P cali data, calculate % sites with P. calif. each year: 

pCal_yrs <- merge(pCal_yrs, sites)%>%
  mutate(site_perc = (n_sites/total_sites)*100)
```

Basic LM: 

```{r}
pcal.site.lm <- lm(site_perc~yr, pCal_yrs)
summary(pcal.site.lm)
```

No change in # sites with *P. californica* present over time. 

Visualization: 

```{r}
ggplot(pCal_yrs, aes(x = yr, y = site_perc))+
  geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(pcal.site.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(pcal.site.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "% of sites with P. californica present")
```



#### iii. Is total abundance changing over time? 

Visualization: 

```{r}
ggplot(pCal_yrs, aes(x = yr, y = tot_abund))+
  geom_point(size = 0.5)+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "grey")+
  theme_classic()+
  labs(x = "Year", y = "Total P. californica abundance")
```

No obvious trends in total abundance over time. 

#### iv. Is mean density changing over time? 

Basic LM: 

```{r}
pcal.dens.yr <- lm(log10(density_xbar)~yr, pCal_yrs)

summary(pcal.dens.yr)
```

Significant decline in P. cal. density over time. 

Visualization:

```{r}
ggplot(pCal_yrs, aes(x = yr, y = log10(density_xbar)))+
 geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(pcal.dens.yr)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(pcal.dens.yr)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Average P. californica density (# individuals/m2)")
```

Significant *decrease* in mean density over time - When averaged across all sites with *P. californica* observations, density (# individuals/m2) has decreased between 2000 and 2023. 

### B. *Zapada*

First, extract all observations of *Zapada* into a new dataframe:

```{r}
zapada <- taxa_densities%>%
  dplyr::filter(sampleDate > "1990-01-01")%>% #dropping observations before 1990
  dplyr::filter(genus == "Zapada", 
         !splitCount == 0) #dropping samples where 0 individuals were counted
```

Check Distribution: 

```{r}
ggplot(zapada, aes(x = log10(density)))+
  geom_histogram()
```

Strong left skew - use log transform. 

#### i. How is density changing over time across all sites? 

Basic LM: 

```{r}
zap.dens.lm <- lm(log10(density)~sampleDate, zapada)
summary(zap.dens.lm)
```

Visualization:

```{r}
ggplot(zapada, aes(x = sampleDate, y = log10(density)))+
  geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(zap.dens.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(zap.dens.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "log10(Zapada Density (individuals/m2))")
```



Significant *decrease* in *Zapada* density over time (ignoring effects of site, etc.)

#### ii. Is prevalence (% sites w/ Zapada per year) changing over time? 

Calculate # unique sites with *Zapada* each year:

```{r}
zapada_yrs <- zapada%>%
  mutate(yr = year(sampleDate))%>% #create new column with year
  group_by(yr)%>% #group by year
  summarise(density_xbar = mean(density), #calculate mean density, # sites with P. Cal., and total abundance for each year
            n_sites = length(unique(siteId)), 
            tot_abund = sum(splitCount))
```

Add total # sites per year and calculate %: 

```{r}
zapada_yrs <- merge(zapada_yrs, sites)%>%
  mutate(site_perc = (n_sites/total_sites)*100)
```


Basic LM: 

```{r}
zap.site.lm <- lm(site_perc~yr, zapada_yrs)
summary(zap.site.lm)
```

Visualization: 

```{r}
ggplot(zapada_yrs, aes(x = yr, y = site_perc))+
  geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(zap.site.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(zap.site.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Number of sites with Zapada present")
```



No change in % of sites with *Zapada* present over time.  

#### iii. Is total abundance changing over time? 

Basic LM: 

```{r}
zap.abund.lm <- lm(tot_abund~yr, zapada_yrs)
summary(zap.abund.lm)
```

Visualization: 

```{r}
ggplot(zapada_yrs, aes(x = yr, y = tot_abund))+
  geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(zap.abund.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(zap.abund.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Total Zapada abundance")
```

No change in Zapada abundance over time. 

#### iv. Is mean density changing over time? 

Basic LM: 

```{r}
zap.dens.yr <- lm(density_xbar~yr, zapada_yrs)

summary(zap.dens.yr)
```

Significant *decrease* in mean density over time - When averaged across all sites with *Zapada* observations, density (# individuals/m2) has decreased between 2000 and 2023. 

Visualization:

```{r}
ggplot(zapada_yrs, aes(x = yr, y = density_xbar))+
  geom_point(size = 0.5)+
  geom_smooth(color = "grey")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(summary(zap.dens.yr)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.85, label = paste("Adj. R2 = ", round(summary(zap.dens.yr)$adj.r.squared, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Average Zapada density (# individuals/m2)")
```


#### v. Zapada above 3000m: 

First, select all sites with elevation >=3000m from zapada dataframe:

```{r}
zapada_hi <- zapada %>% 
  filter(elev_m >=3000)

length(unique(zapada_hi$siteId))
```

27 sites above 3000m - should be plenty to go with that rather than the 10 highest. 

Get site lat/long and elevation for each of these 27 sites:

```{r}
zap_hiSites <- zapada_hi %>%
  select(siteId, siteLongitude, siteLatitude,elev_m)%>% #select site and elevation cols
  distinct()

zap_hiSamples <-zapada_hi %>%
  select(sampleId, siteId, siteLongitude, siteLatitude, elev_m)%>%
  distinct()
```

Export site ID's, stream names, and sample ID's for all of these sites: 

```{r}
# Bring in site names from metadata file: 
site_names <- read.csv("raw_data/Utah_Sample_Data_Final_comids.csv")%>%
  select(sampleId, siteId, waterbodyName)

#merge with Zapada site info: 
zapHi_export <- merge(zap_hiSamples, site_names, all.y = F)%>%
  arrange(waterbodyName)%>%
  rename(elevationMeters = elev_m)

#save
write.csv(zapHi_export, "cleaned_data/high_zapada_info.csv")
```


Check distribution of density at these sites: 

```{r}
ggplot(zapada_hi, aes(x = log10(density)))+
  geom_histogram()
```

Strong left skew, use log transform. 

**Is density changing at these sites?** 

```{r}
ggplot(zapada_hi, aes(x = sampleDate, y = log10(density)))+
  geom_point(size = 0.5)+
  #geom_smooth(size = 0.5)+
  geom_smooth(se = F, method = "lm", color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "Zapada Density (individuals/m2)")
```

Possibly a decline in density over time. 

**Are there trends in prevalence, total abundance, or mean density over time?**

Calculate number of sites w/ high elevation Zapada per year, mean density and total abundance per year:

```{r}
zapHi_yrs <- zapada_hi%>%
  mutate(yr = year(sampleDate))%>% #create new column with year
  group_by(yr)%>% #group by year
  summarise(density_xbar = mean(density), #calculate mean density, # sites with P. Cal., and total abundance for each year
            n_sites = length(unique(siteId)), 
            tot_abund = sum(splitCount))
```

Add total sites each year and calculate % of sites w/ *Zapada*: 

```{r}
zapHi_yrs_pivot <- merge(zapHi_yrs, sites)%>% #merge with site numbers calculated above
  mutate(site_perc = (n_sites/total_sites)*100)%>% #calculate % sites w/ high elevation zapada
  pivot_longer(!yr, names_to = "measure", values_to = "value")%>% #pivot longer for plotting
  filter(!measure == "n_sites", !measure == "total_sites")
```

Check distributions: 

```{r}
ggplot(zapHi_yrs_pivot, aes(x = log10(value)))+
  geom_density(color = "black", fill = "grey")+
  facet_wrap(~measure, scales = "free")+
  theme_classic()
```

All are left skewed; use log transform

Nest data by measure: 

```{r}
zapHi_nest <- zapHi_yrs_pivot%>%
  nest(data = -measure)
```

LM's for each measure:

```{r}
zapHi.lm <- zapHi_nest %>%
  mutate(model = purrr::map(data, ~lm(log10(value)~yr, data =.)%>% #run a model of temp~year for each site (referenced by "."); store results in new column called "model"
                     tidy))%>% #tidy function to construct a summary table with model results (seperate tables for each site)
  unnest(model) %>% #unnest model column to get rows for each site, columns for model metrics
  filter(term == "yr")  #remove intercept term to just get info on year for each site
zapHi.lm
```


Add p-values and plot: 

```{r}
zapHi_pv <- merge(zapHi_yrs_pivot, zapHi.lm)

ggplot(zapHi_pv, aes(x = yr, y = log10(value), color = measure))+
  geom_point(size = 0.5)+
  geom_smooth()+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste("P = ", round(p.value, 2), sep = "")), hjust = 1)+
  geom_smooth(se = F, size = 0.5, method = "lm", color = "red", linetype = "dashed")+
  theme_classic()+
  facet_wrap(~measure, scales = "free")+
  labs(x = "Year", y = "log10(Value)")+
  theme(legend.position = "none")
```

No significant trends in high-elevation Zapada density, site proportion, or abundance.

#### vi. Map of the sites above 3000m:

First, get map data for Utah: 

```{r}
utah <- map_data("state", region = "utah") #state polygon
ut.counties <- map_data("county", region = "utah") #county polygons
```

Make map of Utah with the 10 highest Zapada sites marked: 

```{r}
zap.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = zap_hiSites, aes(x = siteLongitude, y = siteLatitude, color = elev_m, group = NULL), size = 4, pch = 20)+ #add zapada sites, color code by elevation. 
  labs(color = "Site elevation (m)", title = "Sites >3000m elevation with Zapada")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  scale_color_gradient(low = "#DCB0FC", high = "#7004BF")+ #setting color gradient for site colors
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, angle = 45, hjust = 1), 
        legend.position = "bottom", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5) 
        )
zap.map
```

Save this plot: 

```{r}
ggsave("plots/zapada_map.pdf", zap.map, device = "pdf", units = "in", width = 6.5, height = 4.5, dpi = "retina")
```

Plot of high elevation Zapada density over time: 

```{r}
zapHi.scatter <- ggplot(zapHi_yrs, aes(x = yr, y = density_xbar))+
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5, linetype = "dashed")+
  geom_smooth(se = F, method = "lm", color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "High elevation Zapada density (individuals/m2)")+
  theme(axis.title = element_text(size = 10, face = "bold"), 
        axis.text = element_text(size = 9))+
  #ylim(0, 2000)+
  annotate(geom = "text", x = 2011, y = 2000, label = "P = 0.11; Adj. R2 = 0.14", size = 3.5, fontface = "bold")
zapHi.scatter
```

Stack with map and save: 

```{r}
zapHi.stack <- zap.map|zapHi.scatter
zapHi.stack
```

Save: 

```{r}
ggsave("plots/zapHi_trends.pdf", zapHi.stack, device = "pdf", units = "in", width = 11, height = 5, dpi = "retina")
```

### C.  SGCNs from Utah and surrounding states

Read in SGCN data (includes SGCNs from UT, ID, CO, NV, WY, AZ):

```{r}
sgcn <- read.csv("cleaned_data/sgcns.csv")%>%
  mutate(
         spp = word(scientificName, start = 2, end = 2), 
         g_abbrev = paste(substr(genus, 1, 1), ".", sep = ""),
        g_spp = paste(g_abbrev, spp, sep = " ")
         )%>%
  mutate(taxa_state = paste(g_spp, states, sep = " - "),)


sgcn_means <- sgcn %>%
  mutate(yr = year(sampleDate))%>%
  group_by(scientificName, yr)%>%
  summarise(density_xbar = mean(density))

unique(sgcn$states)
```

#### i. Map + density trends for UT SGCNs: 

Filter out UT SGCNs:

```{r}
ut <- sgcn %>%
  filter(str_detect(states, "UT") == T) #filter all rows that include UT in the "states" column
```

Map UT SGCNs, color coded by taxa: 

```{r}
utSGCN.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = ut, aes(x = siteLongitude, y = siteLatitude, color = g_spp, group = scientificName), size = 4, pch = 20)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", title = "Distribution of current Utah SGCNs")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "none", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
        )
utSGCN.map
```

Scatterplot showing trends in density of each species over time: 

First, calculate mean density for each taxa for each year: 

```{r}
ut_means <- ut %>%
  mutate(yr = year(sampleDate))%>% #create year column
  group_by(g_spp, yr)%>% #group by taxa and year
  summarise(density_xbar = mean(density), #calculate mean density
            tot_abund = sum(splitCount)) #and total abundance
```

```{r}
utSGCN.scatter <- ggplot(ut_means, aes(x = yr, y = density_xbar, color = g_spp))+
  geom_point()+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Mean taxa density (# individuals/m2)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 10, face = "italic"), 
        legend.position = "none"
        )+
  facet_wrap(~g_spp, scales = "free")
utSGCN.scatter
```

Are any of these trends significant? 

```{r}
ut_nested <- ut_means%>%
  nest(data = -g_spp)
```

Run a model for each taxa separately, return a summary table with model results for each taxa: 

```{r}
ut_models <- ut_nested %>%
  mutate(model = purrr::map(data, ~lm(density_xbar~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
ut_models
```

No significant trends (unsurprising, not much data). 

Add elevation figure: 

```{r}
utSGCN.elev <- ggplot(ut, aes(x = sampleDate, y = elev_m, color = scientificName))+
  geom_point()+
  theme_classic()+
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(x = "Sample Date", y = "Elevation (m)")
utSGCN.elev
```


Stack with map: 

```{r}
utSGCN.stack <- utSGCN.map|utSGCN.scatter
utSGCN.stack
```

Save: 

```{r}
ggsave("plots/utSGCN.pdf", utSGCN.stack, device = "pdf", units = "in", width = 11, height = 5, dpi = "retina")
```

#### ii. Map + density trends for SGCNs from all other states

Drop UT SGCNs, keep all others:

```{r}
other_states <- sgcn %>%
  filter(!(str_detect(states, "UT") == T))%>% #drop all rows that include UT in the "states" column
  mutate(taxa_state = paste(g_spp, states, sep = " - "))
```

Make a map of all SGCN's from other states - color code by taxa, different shapes for each state: 

```{r}
adjSGCN.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = other_states, aes(x = siteLongitude, y = siteLatitude, color = taxa_state, shape = states), size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "State", title = "Distribution of SGCNs from neighboring states")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "bottom", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
        )
adjSGCN.map
```

Make plots of density over time - first, calculate mean density for each taxa*yr

```{r}
other_means <- other_states %>%
  mutate(yr = year(sampleDate))%>% #add year column
  group_by(taxa_state, yr)%>% #group by taxa and year
  summarise(density_xbar = mean(density),  #calculate density
            tot_abund = sum(splitCount), #calculate total abundance
            scientificName = unique(scientificName),
            states = unique(states)) #retain states column

 #get rid of taxa w/ only 1 year of data: 
oneyr <- other_means %>% #create new obj
  group_by(taxa_state)%>%  #group by taxa
  summarise(n_yrs = length(unique(yr)) 
            ,scientificName = unique(scientificName)
            )%>% #count # years for that taxa
  filter(n_yrs == 1) #extract rows with only 1 observation

other_multiyear <- other_means %>%
  filter(!taxa_state%in%oneyr$taxa_state) #drop taxa with only 1 year of data
```

Create plot: 

```{r}
adjSGCN.scatter <- ggplot(other_multiyear, aes(x = yr, y = density_xbar, color = taxa_state, shape = states))+
  geom_point()+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Mean taxa density (# individuals/m2)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
  facet_wrap(~taxa_state, scales = "free")
adjSGCN.scatter
```

Stack and save: 

```{r}
adjSGCN.stack <- adjSGCN.map|adjSGCN.scatter
adjSGCN.stack

ggsave("plots/adjacentSGCN.pdf", adjSGCN.stack, device = "pdf", units = "in", width = 12, height =6, dpi = "retina")
```

Are any of these trends statistically significant? 

Basic LM of density ~ year for each taxa: 

Nest data by taxa: 

```{r}
sgcn_nested <- other_multiyear%>%
  nest(data = -taxa_state)
```

Run a model for each taxa separately, return a summary table with model results for each taxa: 

```{r}
sgcn_models <- sgcn_nested %>%
  mutate(model = purrr::map(data, ~lm(density_xbar~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
sgcn_models
```

Significant decline in *P. californica*, weakly significant increase in *H. azteca*. 

Overview map:

```{r}
AllSGCN.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = sgcn, aes(x = siteLongitude, y = siteLatitude, color = taxa_state, shape = states), size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "State", title = "Distribution of SGCNs from Utah & neighboring states")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "bottom", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
        )+
  scale_shape_manual(values = c(16, 17, 15, 3, 7, 18, 8))+
  scale_color_manual(values = hue_pal()(20))
AllSGCN.map
```

Save: 

```{r}
ggsave("plots/sgcn_plots/sgcn_overview.pdf", AllSGCN.map, device = "pdf", units = "in", height = 9, width = 6.5, dpi = "retina")
```

#### iii. Map + density + elevation for each SGCN taxa

Goal is to produce a map + density plot + elevation plot for each SGCN in the dataset. Including SGCNs from all states, there are 18 total: 

```{r}
sort(unique(sgcn$scientificName))
```

Omitting Taxa with only one year of data: 

```{r}
sgcn_multiyear <- filter(sgcn, !scientificName%in%oneyr$scientificName)
sort(unique(sgcn_multiyear$scientificName))
``` 

For each SGCN taxa, want to produce a map of that taxa's distribution in Utah next to stacked plots showing the taxa density over time and site elevations over time. 

First, add color and shape palates to keep color/shape scheme the same as the overview map: 

```{r}
taxa_colors <- sgcn %>%
  select(scientificName, states)%>% 
  distinct()%>%
  mutate(taxa_color = hue_pal()(20)) #creating dataframe with column containing hex codes for each of the 18 colors used for each taxa in the overview map

state_shapes <- sgcn %>%
  select(states)%>%
  distinct()%>%
  mutate(state_shape = c(16, 17, 15, 3, 7, 18, 8)) #creating dataframe with column with the shape code used for each different state in the overview map

taxa_state_pals <- merge(taxa_colors, state_shapes) #merging these DF's to get new dataframe with taxa names, colors, and state shape codes


sgcn_plot <- merge(sgcn, taxa_state_pals) #merge this DF with the SGCN data to add shape codes and taxa colors to the entire dataset
```

Plotting for each taxa using a for loop: 

```{r}
sgcn.names <- c(sort(unique(sgcn_multiyear$scientificName))) #make a list of all SGCNs with multiple years of data
plot.list <- list() #initialize empty list for storing plots

for(i in 1:length(sgcn.names)){ #Open for loop, iterate over each taxa name in the sgcn.names list
  dat <- filter(sgcn_plot, scientificName == sgcn.names[i]) #Create temporary dataframe with data for the "ith" taxa, then plot using that data:
  
#Map  
  m <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = dat, aes(x = siteLongitude, y = siteLatitude, color = taxa_color, shape = factor(state_shape)), color = dat$taxa_color, pch = dat$state_shape, size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "State", #updating legend title
       title = paste("Distribution of", unique(dat$scientificName), "in Utah", sep = " ") #adding plot title using taxa name
       )+ 
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "none", 
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5)
        )
  
  #Density: 
d <- ggplot(filter(sgcn_means, scientificName == sgcn.names[i]), aes(x = yr, y = density_xbar))+
  geom_point(color = unique(dat$taxa_color), pch = unique(dat$state_shape))+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = unique(dat$taxa_color))+
  theme_classic()+
  labs(x = "Year", y = "Mean taxa density", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
   annotation_custom(grid::textGrob( #adding custom annotation to plot to add P value for density ~ year
     paste("P = ", round(summary(lm(density_xbar~yr, filter(sgcn_means, scientificName == sgcn.names[i])))$coefficients[,4][2], 3), sep = ""), #label = pasting "P =" and the P value from a simple lm of density ~ year
                                    0.9, 0.9, #adjusting label position (relative to plot area)
     gp = grid::gpar(fontsize = 10))) #adjusting font size

#Elevation
e <- ggplot(filter(sgcn, scientificName == sgcn.names[i]), aes(x = year(sampleDate), y = elev_m))+
  geom_point(color = unique(dat$taxa_color), pch = unique(dat$state_shape))+
  theme_classic()+
  labs(x = "Year", y = "Sample Elevation (m)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
  scale_y_continuous(limits = c(min(sgcn$elev_m), max(sgcn$elev_m))) #setting y limits = to min and max elevations in the dataset so that all plots will be on the same scale

#combine all three plots: map next to density stacked above elevation
comb <- m|(d/e)

plot.list[[i]]<-comb #save plot as "ith" object in plot.list

fp <- paste("plots/sgcn_plots/", sgcn.names[i], ".pdf", sep = "") #generate filepath for saving pdf

ggsave(fp, comb, device = "pdf", units = "in", height = 4.5, width = 8, dpi = "retina") #save pdf of combined plot
print(paste("completed", sgcn.names[i], sep = " ")) #return taxa name for tracking while code is running
}

```

To check individual plots - call plot.list[[#]] - e.g: 

```{r}
plot.list[[3]]
```

Final plots: Map of species with only 1 yr of data + elevations for those taxa: 

```{r}
#Data Setup: 
sgcn_oneyr <- sgcn_plot %>%
  filter(scientificName%in%oneyr$scientificName)

#Map: 
oneyr.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = sgcn_oneyr, aes(x = siteLongitude, y = siteLatitude, color = scientificName, shape = factor(state_shape)), size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "Listing State(s)", #updating legend title
       title = "Additional SGCNs with <2yrs data" #adding plot title using taxa name
       )+ 
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "right", 
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5)
        )+
  scale_color_manual(values = unique(sgcn_oneyr$taxa_color), labels = unique(sgcn_oneyr$scientificName))+
  scale_shape_manual(values = unique(sgcn_oneyr$state_shape), labels = unique(sgcn_oneyr$states))


#Elevations: 
oneyr.elev <- ggplot(sgcn_oneyr, aes(x = year(sampleDate), y = elev_m, color = scientificName, shape = states))+
  geom_point(size = 3)+
  theme_classic()+
  labs(x = "Year", y = "Sample Elevation (m)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
  scale_color_manual(values = unique(sgcn_oneyr$taxa_color), labels = unique(sgcn_oneyr$scientificName))+
  scale_shape_manual(values = unique(sgcn_oneyr$state_shape), labels = unique(sgcn_oneyr$states))+
  scale_y_continuous(limits = c(min(sgcn$elev_m), max(sgcn$elev_m))) #setting y limits = to min and max elevations in the dataset so that all plots will be on the same scale

#Stack:
oneyr.comb <- oneyr.map|oneyr.elev
oneyr.comb

#Save:
ggsave("plots/sgcn_plots/sgcns_oneYr.pdf", oneyr.comb, device = "pdf", units = "in", height = 4.5, width = 8, dpi = "retina") #save pdf of combined plot


```


## IV. Effects of sampling design (lab split, field split, area sampled) on total sample density

First, need to calculate total density in each sample: 

```{r}
total_dens <- taxa_densities%>%
  group_by(sampleId)%>% # group by sample ID
  summarise(labSplit = mean(labSplit), #Add sample lab split, field split, and area
            fieldSplit = mean(fieldSplit), 
            tot_dens = sum(density), # calculate total density in sample
            area = mean(area))%>%
  mutate(sample_prop = labSplit*fieldSplit)%>% #calculate sample proportion (labSplit*fieldSplit)
  filter(!tot_dens == 0)

```


### A. Density vs. LabSplit: 

Basic plot:

```{r}
dens.labsplit <- ggplot(filter(total_dens, !labSplit == 1), aes(x = labSplit, y = tot_dens))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(y = "Total Sample Density", x = "")
dens.labsplit
```


Log transformed plot: 

```{r}
dens.labsplit.log <- ggplot(total_dens, aes(x = labSplit, y = log10(tot_dens)))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed", method = "lm")+
  annotate(geom = "label", x = 0.5, y = 0.2, label = "P <0.001; R2 = 0.55")+
  theme_classic()+
  labs(y = "log10(Total Sample Density)", x = "Lab Split Proportion")
dens.labsplit.log
```

Basic LM: 

```{r}
dens.ls.lm <- lm(log10(tot_dens)~labSplit, filter(total_dens, labSplit >=0.25, !labSplit == 1))
summary(dens.ls.lm)
```

Significant negative relationship between lab split and total sample density. 



### B. Density vs. Sample Proportion (lab split * field split): 

Basic plot:

```{r}
dens.sampleprop <- ggplot(total_dens, aes(x = sample_prop, y = tot_dens))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(y = "", x = "")
dens.sampleprop
```


Log transformed plot: 

```{r}
dens.sampleprop.log <- ggplot(total_dens, aes(x = sample_prop, y = log10(tot_dens)))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed", method = "lm")+
  annotate(geom = "label", x = 0.5, y = 0.2, label = "P <0.001; R2 = 0.55")+
  theme_classic()+
  labs(y = "log10(Total sample density)", x = "Sample Proportion")
dens.sampleprop.log
```

Basic LM: 

```{r}
dens.sp.lm <- lm(log10(tot_dens)~sample_prop, total_dens)
summary(dens.sp.lm)
```

Significant negative relationship between sample proportion and total sample density. 


### C. Sample Area

Basic plot:

```{r}
dens.area <- ggplot(filter(total_dens, area <50), aes(x = area, y = tot_dens))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(y = "", x = "")
dens.area
```

Log transformed plot: 

```{r}
dens.area.log <- ggplot(filter(total_dens, area <50), aes(x = area, y = log10(tot_dens)))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed", method = "lm")+
  annotate(geom = "label", x = 1.75, y = 0.1, label = "P <0.001; R2 = 0.10")+
  theme_classic()+
  labs(y = "log10(Total sample density)", x = "Sample area, m2")
dens.area.log
```

Basic LM: 

```{r}
dens.ar.lm <- lm(log10(tot_dens)~area, filter(total_dens, area <50))
summary(dens.ar.lm)
```

Significant negative relationship between sample proportion and total sample density. 



### D. Create summary figure of all three:

```{r, message = F, warning = F}
dens.samplemethod <- (dens.labsplit/dens.labsplit.log)|(dens.sampleprop/dens.sampleprop.log)|(dens.area/dens.area.log)
dens.samplemethod
```

Save:

```{r}
ggsave("plots/dens_samplemethod.pdf", dens.samplemethod, device = "pdf", units = "in", height = 6.5, width = 9, dpi = "retina")
```

##### **Summary:**

log10(Density) has a significant negative correlation with lab split, sample proportion (lab split * field split), and area. The R2 for lab split and sample proportion are fairly hight (0.55), while the R2 for area is very low (0.1). 

## V. Ecoregion-level analyses

Read in ecoregion density/richness info:

```{r}
eco_r_d <- read.csv("cleaned_data/ecoregion_cleaned.csv")%>%
  mutate(sampleDate = ymd(sampleDate))
head(eco_r_d)
```

Check distribution of richness & density 

```{r}
#data re-organization:
hist_eco <- eco_r_d %>%
  select(ecoName, yr, richness, tot_dens
         )%>%
  pivot_longer(!c(ecoName, yr), names_to = "type", values_to = "value")%>%
  mutate(logtrans = log10(value))

ggplot(hist_eco, aes(x = value))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()

ggplot(hist_eco, aes(x = logtrans))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()+
  labs(x = "log10(value)")
```

Log transform for density only

### A. Are there trends in richness over time within each ecoregion?


Nest data by ecoregion: 

```{r}
eco_nested <- eco_r_d%>%
  nest(data = -ecoName)
```

Run a model for each ecoregion separately, return a summary table with model results for each: 

```{r}
ecoRichness.overall.lm <- eco_nested %>%
  mutate(model = purrr::map(data, ~lm(richness~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
ecoRichness.overall.lm
```

No significant trends in overall richness. 

Visualization: 

```{r}
library(ggpp)

eco.ro.pv <- ecoRichness.overall.lm%>%
  select(ecoName, p.value)

eco_ro_pvals <- merge(eco_r_d, eco.ro.pv)

eco.overall.richness <- ggplot(eco_ro_pvals, aes(x = yr, y = richness, color = ecoName))+
  geom_point(size = 0.5)+
  geom_smooth(method = "lm", se = F, linetype = "dashed", size = 0.5, color = "black")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  theme_classic()+
  facet_wrap(~ecoName, scales = "free_y", nrow = 1, ncol = 4)+
  labs(x = "Year", y = "Taxonomic richness", color = "Ecoregion Name")+
  theme(legend.position = "none", 
        axis.title = element_text(size = 10, face = "bold"), 
        strip.text = element_text(size = 8))
eco.overall.richness
```

### B. Are there trends in density over time within each ecoregion

Run a model for each ecoregion separately, return a summary table with model results for each: 

```{r}
ecoDens.overall.lm <- eco_nested %>%
  mutate(model = purrr::map(data, ~lm(log10(tot_dens)~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
ecoDens.overall.lm
```

Significant declines in overall density in all three ecoregions

Visualization: 

```{r}
eco.do.pv <- ecoDens.overall.lm%>%
  select(ecoName, p.value)

eco_do_pvals <- merge(eco_r_d, eco.do.pv)

eco.overall.dens <- ggplot(eco_do_pvals, aes(x = yr, y = log10(tot_dens), color = ecoName))+
  geom_point(size = 0.5)+
  geom_smooth(method = "lm", se = F, size = 0.5, linetype = "dashed", color = "black")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste( "P = ",round(p.value, 2), sep = "")))+
  theme_classic()+
  facet_wrap(~ecoName, scales = "free_y", nrow = 2, ncol = 4)+
  labs(x = "Year", y = "log10(Mean sample density)", color = "Ecoregion Name")+
  theme(legend.position = "none", 
        axis.title = element_text(size = 10, face = "bold"), 
        strip.text = element_text(size = 8))
eco.overall.dens
```


### C. Combining Plots and saving:

Combine plots: 

```{r}
ecoregion.analyses <- (eco.overall.richness/eco.overall.dens)
ecoregion.analyses
```

Save:

```{r}
ggsave("plots/ecoregion_rd_analyses.pdf", ecoregion.analyses, device = "pdf", units = "in", dpi = "retina", width = 12, height = 6.5)
```


## VI. Elevation band analysis

Goal: split up data into elevational bands, calculate total richness and mean total sample density in each band for each year. Data cleaning criteria (in addition to basic labSplit, area, etc.) include: 

  - Dropping all samples with <300 individuals (already done in UTinvert_data_cleaning.Rmd script)
  
  - Randomly subsampling remaining samples to 300 individuals (already done in UTinvert_data_cleaning.Rmd script)
  
  - Adding elevation bands; dropping elevation band * year combos with fewer than 10 sites; calculating per-site density and richness (will be done below). 
Read in dataset:

```{r}
subsetted <- read.csv("cleaned_data/subsetted_full.csv")
```

### A. Data Cleaning

#### i. Read in data:

```{r}
elev_bands <- read.csv("cleaned_data/elev_bands_cleaned.csv")%>%
  select(!X)%>%
  mutate(sampleDate = ymd(sampleDate))
head(elev_bands)
```


#### iii. Checking distributions

Check distribution of richness, density, and per-site richness and density: 

```{r}
#data re-organization:
elev_pivot <- elev_bands %>%
  pivot_longer(!c(sampleId:sampleProp, elev_m:ecoName) 
                  , names_to = "type", values_to = "value")%>%
  mutate(logtrans = log10(value))%>%
  filter(!str_detect(type, "insect"), !type == "tot_abund")

ggplot(elev_pivot, aes(x = value))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()

ggplot(elev_pivot, aes(x = logtrans))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()+
  labs(x = "log10(value)")
```

Use log transform for density, not for richness

Add column with log transform for all except overall richness:

```{r}
elev_pivot <- elev_pivot %>%
  mutate(transform = ifelse(type == "richness", value, log10(value)))
```

Check number of years in each band: 

```{r}
elev_pivot %>%
  group_by(elev_band)%>%
  summarise(n_yrs = length(unique(yr)))%>%
  ggplot(aes(x = elev_band, y = n_yrs, fill = n_yrs))+
  geom_bar(stat = "identity")+
  geom_text(aes(label = n_yrs, color = n_yrs), hjust = 0.5, vjust = -0.5, fontface = "bold")+
  theme_classic()+
  theme(legend.position = "none")
```

only 4 years data in >2600 class

### B. Modeling

First, nest pivoted data elevation band and measure type: 

```{r}
elev_nest <- elev_pivot %>%
  nest(data = -c(elev_band, band_code, type))
```

Run model for each band and measure: 

```{r}
elev.lms <- elev_nest %>%
  mutate(model = purrr::map(data, ~lm(transform~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
elev.lms
```

Add p-values and prep for plotting:

```{r}
elev_pv <- merge(elev_pivot, elev.lms)%>% #add p-values
  group_by(elev_band)%>% #group by elevation band
  mutate(n_yrs = length(unique(yr)))%>% #add col with # years per band
  ungroup()%>% #ungroup to retain all columns
  filter(!n_yrs <4)%>% #drop all bands with <4yrs data
  mutate(name = case_when( 
    type == "richness"~"Richness", 
   # type == "richness_perSample"~"Richness (per-sample)", 
    type == "tot_dens"~"Total sample density" 
   # ,type == "density_perSample"~"Mean density (per-sample)"#add column with full names for plot labeling
  ),
         transform_name = ifelse(type == "richness", name, paste("log10(", name, ")", sep = ""))) #adding transform (log10 for everything except Richness)

y.labs <- unique(elev_pv$transform_name)
names(y.labs) <-unique(elev_pv$transform_name) #creating named vector of different measurement types for use on facet labels in plot

bands <- elev_pv%>% #extracting distinct band codes and labels
  select(band_code, elev_band)%>%
  distinct()%>%
  arrange(band_code) 

band.labs <- bands$elev_band
names(band.labs)<-bands$band_code #creating a named vector of band labels + codes to use for facet labels in plot

band.pal <- c("#543005","#BF812D","#DFC27D", "#80CDC1", "#35978F") #setting color palatte
```

Draw plot: 

```{r}
elev.grid <- ggplot(elev_pv, aes(x = yr, y = transform, color = factor(band_code)))+ 
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "black")+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.9, label = paste("P = ", round(p.value, 2))), size = 3.25, #add p-values to each plot, rounding to 2 decimal places
                fontface = ifelse(elev_pv$p.value<=0.05, "bold", "plain"))+ #change font face to bold if P<0.05
  theme_classic()+
  facet_grid(cols = vars(band_code), rows = vars(transform_name), scales = "free_y", #facet grid by elevation band (x) and measurement type (y)
             labeller = labeller(.cols = band.labs, .rows = y.labs, #setting x and y facet labels based on named vectors created above
                                 .default = label_wrap_gen(20)), #wrapping facet labels to get rid of overlap
             switch = "y")+ #moving y facet labels to L side of plot
  theme(legend.position = "none", #get rid of legend
        strip.placement = "outside", #move y facet labels outside of y axis
        strip.background.y = element_blank(), 
        strip.text = element_text(size = 10), 
        axis.text.x = element_text(size = 9, angle = 45, hjust=1), 
        axis.title = element_text(size = 10), #updating text aesthetics
        )+
  scale_color_manual(values = band.pal[1:5])+
  labs(x = "Year", y = "")
elev.grid
```

Save plot: 

```{r}
ggsave("plots/elevation_grid_FULL_NEW.pdf",elev.grid, device = "pdf", units = "in", dpi = "retina", height = 8, width = 6.5)
```


## VII. Taxonomic Patterns

Goal: how are key taxonomic groups changing over time? Are there trends in abundance, richness, or density? 

Workflow - Start with full density dataset (taxa_densities), then:

  - Pull out all observations in order "A"
  
  - For each sample, calculate: species richness, total density, total abundance
  
  - For each year, calculate: mean sample richness, mean sample density, mean sample abundance (Also calculate each on a per-sample basis)
  
  - Plot density, abundance, and richness over time; run basic LM's (using log transform if needed) to test for trends. 
  
### A. EPTO

First group of interest: EPTO (Ephemeroptera, Plecoptera, Trichoptera, Odonata)

#### i. Calculations:

Make a vector of these order names; initiate a list to hold loop outputs: 

```{r}
epto <- c("Ephemeroptera", "Plecoptera", "Trichoptera", "Odonata", "Diptera") #vector of order names

epto_list <- list() #empty list for data storage

base.plots <- list() #empty list for checking distribution of data (untransformed)
trans.plots <- list() #empty list for checking distribution of data (transformed)
summary.plots <- list() #empty list for storing summary plots of abundance, richness, and density
```

Run for loop to extract data from each group, calculate richness/density/abundance per sample and year, run models for each, and produce summary figures: 

```{r}
for(i in 1:length(epto)){
  temp <- taxa_densities %>%
    select(sampleId, yr, order, tot_dens, tot_abund, richness)%>%
    distinct()%>%
    filter(order == epto[i])%>% #extract all rows with order = "ith" item in the epto vector created above
    pivot_longer(!c(sampleId, yr, order), names_to = "type", values_to = "value")%>% #pivot longer for smoother plotting/analysis
    mutate(transform = ifelse(type == "richness", value, log10(value)), #adding log10 transformed column
           label = case_when(
             type == "tot_dens"~"log10(Total sample density)", 
             type == "tot_abund"~"log10(Total sample abundance)", 
             type == "richness" ~ "Sample richness" #adding new column with labels to be used for facet labels in plots
           ))%>%
    filter(!value == 0)
  
  base.plots[[i]] <- ggplot(temp, aes(x = value))+
    geom_density(fill = "grey", color = "black")+
    theme_classic()+
    facet_wrap(~type, scales = "free") #density plot of un-transformed data
  
  trans.plots[[i]] <- ggplot(temp, aes(x = transform))+
    geom_density(fill = "grey", color = "black")+
    theme_classic()+
    facet_wrap(~type, scales = "free") #density plot of log transformed data
  
  temp_nest <- temp %>%
    nest(data = -c(type)) #nest data by type
  
  temp.lm <- temp_nest %>%
  mutate(model = purrr::map(data, ~lm(transform~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr") #run a model for each type; save results in temp.lm
  
  temp_pv <- merge(temp, temp.lm)%>% #add p-values (and other model info) to the temp dataset
    arrange(type, yr)
  
  
  
  epto_list[[i]] <- temp_pv #save output as "ith" item in epto_list
  
  summary.plots[[i]]<-ggplot(epto_list[[i]], aes(x = yr, y = transform))+ #create summary plot of abundance, density, and richness vs. year
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5, color = "darkgrey")+
  geom_smooth(se = F, method = "lm", size = 0.5, color = "red", linetype = "dashed")+ #add points, smoothed line, and line of best fit
  theme_classic()+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste(" P =", round(p.value, 2), sep = "")))+ #add corresponding p-value to plot
  labs(x = "Year", y = "Value", title = unique(epto_list[[i]]$order))+ #axis labels + plot title
  facet_wrap(~label, scales = "free")+
  theme(plot.title = element_text(face = "bold", size = "12", hjust = 0.5), 
        strip.text = element_text(face = "bold", size = 11), 
        axis.title.y = element_text(face = "bold", size = 11), 
        axis.title.x = element_blank(), 
        axis.text = element_text(size = 10)) #formatting title, strip, and axis text
  
  print(paste("Finished", epto[i], sep = " ")) #print order name to keep track of progress
  
}
```


#### ii. Visualizations: 

```{r, message = F, warning = F}
epto.stack <- summary.plots[[1]]/summary.plots[[2]]/summary.plots[[3]]/summary.plots[[4]]
epto.stack

```

Save:

```{r}
ggsave("plots/epto_analyses.pdf", epto.stack, device = "pdf", units = "in", height = 11, width = 8.5, dpi = "retina")
```

### B. Chironomidae

**NOTE** because most Chironomidae aren't classified to the genus-level, this dataset has all levels of taxonomic classification within that family. Aside from that, the data cleaning steps are the same.  

Read in data: 

```{r}
chiro <- read.csv("cleaned_data/chironomidae.csv")
```

Calculate total density and abundance for each sample:

```{r}
chiro_groups <- chiro%>%
  group_by(sampleId, sampleDate, yr)%>% #group by sample ID and year; retain sampleDate column
  summarise(tot_dens=sum(density), #calculate total sample density
            tot_abund = sum(splitCount)) #calculate total sample abundance
```

Check distribution: 

```{r}
# Data prep:
chiro_pivot <- chiro_groups%>%
  pivot_longer(!c(sampleId, sampleDate, yr), names_to = "type", values_to = "value")%>%
  mutate(transform = log10(value))%>%
  filter(!value == 0)

#Plotting: 

#without transform:
ggplot(chiro_pivot, aes(x = value))+
  geom_density(fill = "grey", color = "black")+
  theme_classic()+
  facet_wrap(~type, scales = "free")

#with transform:
ggplot(chiro_pivot, aes(x = transform))+
  geom_density(fill = "grey", color = "black")+
  theme_classic()+
  facet_wrap(~type, scales = "free")
```

Both strongly left-skewed; use log transform

Nest data; run LM's: 

```{r}
chiro_nest <- chiro_pivot %>%
  nest(data = -type)

chiro.lm <- chiro_nest %>%
  mutate(model = purrr::map(data, ~lm(transform~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")

chiro.lm
```

Add P-values: 

```{r}
chiro.pv <- chiro.lm %>%
  select(type, p.value)

chiro_pv <- merge(chiro_pivot, chiro.lm)%>%
  mutate(full_label = ifelse(type == "tot_dens", "Total Sample Density", "Total Sample Abundance"))
```

Plot: 

```{r}
chiro.plot<-ggplot(chiro_pv, aes(x = yr, y = transform))+ #create summary plot of abundance & density vs. year
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5, color = "darkgrey")+
  geom_smooth(se = F, method = "lm", size = 0.5, color = "red", linetype = "dashed")+ #add points, smoothed line, and line of best fit
  theme_classic()+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.95, label = paste(" P =", round(p.value, 2), sep = "")))+ #add corresponding p-value to plot
  labs(x = "Year", y = "Value", title = "Chironomidae")+ #axis labels + plot title
  facet_wrap(~full_label, scales = "free")+
  theme(plot.title = element_text(face = "bold", size = "12", hjust = 0.5), 
        strip.text = element_text(face = "bold", size = 11), 
        axis.title.y = element_text(face = "bold", size = 11), 
        axis.title.x = element_text(face = "bold", size = 11), 
        axis.text = element_text(size = 10)) #formatting title, strip, and axis text
chiro.plot
```

Save plot:

```{r}
ggsave("plots/chironomidae.pdf", chiro.plot, device = "pdf", units = "in", dpi = "retina", width = 6.5, height = 4)
```

