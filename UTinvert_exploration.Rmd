---
title: "Utah Invert Data Analysis"
author: "Gordon Gianniny"
date: "2023-05-18"
output: html_document
---

```{r, include = F}
#Loading packages:

library(tidyverse) #For data wrangling
library(lubridate) #For working with dates
library(ggplot2) #Plotting
library(RColorBrewer)
library(patchwork)
library(stringr)
library(vegan)
library(broom)
library(sp)
library(maps) #mapping with ggplot2
library(ggmap) #for mapping w/google map basemaps
library(scales)

#Setting up ggmap API key: NOTE - for the map figures to work, you'll need to set up a Google Maps Platform Console Account at
#https://cloud.google.com/maps-platform/, create an API key, and store it in your .Renviron file as "GOOGLEMAPS_API_KEY". 

maps_api_key <- Sys.getenv("GOOGLEMAPS_API_KEY")
register_google(key = maps_api_key)
```

## Overview

This document carries out all analysis for the Utah Aquatic Insect Decline project. Input files are: 

1. **longterm_site_richness.csv**: yearly average richness and abundance data for each site with at least 4 years of data (n = 142 sites)

2. **longterm_comid_richness.csv**: yearly average richness and abundance data for each COMID segment with at least 4 years of data (n = 211 COMIDs)

3. **taxa_densities.csv**: abundance and density info for each taxa in each sample (pre-richness calculations) - used for investigating specific taxa of interest. 

Sections are: 

1. Initial data visualizations & basic analysis

* By Site: Checking distribution, examining trends in richness & density over time (site-by-site & overall) 
    
* By COMID: Checking distribution, examining trends in richness & density over time (site-by-site & overall)

2. Taxa of interest

* Pteronarcys californica
    
* Zapada

3. Effects of sampling design (lab split, field split, area sampled) on total sample density

Read in datafiles: 

```{r}
site_inverts <- read.csv("cleaned_data/longterm_site_richness.csv")
comid_inverts <- read.csv("cleaned_data/longterm_comid_richness.csv")
taxa_densities <-read.csv("cleaned_data/taxa_densities.csv")%>%
  mutate(sampleDate =ymd(sampleDate))
```

## I. Initial data visualizations & Basic LM's

### A. By Site: 

#### i. Checking distributions: 

Richness:

```{r}
ggplot(site_inverts, aes(x = richness_xbar))+
  geom_histogram(fill = "Grey", color = "Black", bins = 70)+
  theme_classic()+
  labs(x = "Mean Richness", y = "Count")
```

Data are fairly normally distributed, maybe slightly bimodal. 

Density:

```{r}
ggplot(site_inverts, aes(x = density_xbar))+
  geom_histogram(fill = "Grey", color = "Black", bins = 70)+
  theme_classic()+
  labs(x = "Mean Total Density", y = "Count")
```

Strongly left-skewed - try a log transform:

```{r}
ggplot(site_inverts, aes(x = log10(density_xbar)))+
  geom_histogram(fill = "Grey", color = "Black", bins = 70)+
  theme_classic()+
  labs(x = "log10(Mean Total Density)", y = "Count")
```

Better, still slightly skewed - will use log transform for all density plots for now. 

#### ii. Richness over time: 

Visualization:

```{r, warning=F}
site.trends <- ggplot(site_inverts, aes(y = richness_xbar, x = yr, color = factor(siteId)))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5)+
  theme_classic()+
  facet_wrap(~factor(siteId), scales = "free")+
  theme(legend.position = "none", 
        strip.text = element_blank(),
        strip.background = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank())+
  labs(x = "Year", 
       y = "Mean Richness")
site.trends
```

A few initial observations: 

  * No consistent trend across all sites - some look flat, some increase, some decrease. 
  
  * Seems like most sites with longer-term data (more points) generally have increasing trends. 
  
  * Very clear trends (+ or -) at some sites, others are more scattered. 
  
  * Would be cool to see if there's some other variable (location, elevation, land use, etc) that explains different trends @ different sites (i.e. why some are increasing, others are decreasing)


Save: 

```{r}
ggsave("plots/site_richness_trends.jpg", site.trends, device = "jpeg", height = 8.5, width = 8.5, units = "in", dpi = "retina")
```

Same visualization as above, but color coded by elevation:

```{r, warning=F}
site.elev.trends <- ggplot(site_inverts, aes(y = richness_xbar, x = yr, color = elev_m))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5)+
  theme_classic()+
  facet_wrap(~factor(elev_m), scales = "free")+
  theme(legend.position = "bottom", 
        strip.text = element_blank(),
        strip.background = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.text = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Year", 
       y = "Mean Richness", color = "Elevation, m")
site.elev.trends
```

Doesn't seem to be any consistent pattern across elevations - have both increasing and decreasing trends at all elevations. 


#### iii. Density over time:

Visualization (color coded & sorted by elevation):

```{r, warning=F}
site.elev.dens <- ggplot(site_inverts, aes(y = log10(density_xbar), x = yr, color = elev_m))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5)+
  theme_classic()+
  facet_wrap(~factor(elev_m), scales = "free")+
  theme(legend.position = "bottom", 
        strip.text = element_blank(),
        strip.background = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        legend.text = element_text(angle = 45, vjust = 1, hjust = 1))+
  labs(x = "Year",
       y = "log10(Mean Total Density)", color = "Elevation, m")
site.elev.dens
```

Similar to richness - some sites increasing, others decreasing. No obvious/consistent patterns across elevations. 



**Try making a map color coded by site trend?**
 
### B. State-wide trends in richness and density:

First, read in statewide average richness and density data: 

```{r}
statewide <- read.csv("cleaned_data/statewide_richness_density.csv")
head(statewide)
```

Check distribution of data: 

```{r}
#data re-organization:
hist_dat <- statewide %>%
  pivot_longer(!c(X, yr, n_sites), names_to = "type", values_to = "value")%>%
  mutate(logtrans = log10(value))

ggplot(hist_dat, aes(x = value))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()

ggplot(hist_dat, aes(x = logtrans))+
  geom_density(fill = "grey", color = "black")+
  facet_wrap(~type, scales = "free")+
  theme_classic()+
  labs(x = "log10(value)")
```

Both per-site values are skewed, log transform helps a bit. Overall richness is fine without; overall density also skewed. 

#### i. Richness over time: 

**Overall Richness:**

Basic LM testing for trends in state-wide richness: 

```{r}
statewide.richness.lm <- lm(richness~yr, statewide)
summary(statewide.richness.lm)
```

Significant increase in richness over time. 

Visualization:

```{r}
statewide.richness <- ggplot(statewide, aes(y = richness, x = yr))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "darkgrey")+
  geom_text(aes(x = 2020, y = 390, label = paste("P = ", round(summary(statewide.richness.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text(aes(x = 2020, y = 370, label = paste("Adj. R2 = ", round(summary(statewide.richness.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  theme_classic()+
  labs(x = "Year", 
       y = "Richness")
statewide.richness
```

**Per-site richness:**

Basic LM testing for trends in state-wide per-site richness: 

```{r}
persite.richness.lm <- lm(log10(richness_persite)~yr, statewide)
summary(persite.richness.lm)
```

Marginally significant decrease in per-site richness over time

Visualization:

```{r}
persite.richness <- ggplot(statewide, aes(y = log10(richness_persite), x = yr))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "darkgrey")+
  geom_text(aes(x = 2020, y = 1, label = paste("P = ", round(summary(persite.richness.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text(aes(x = 2020, y = 0.95, label = paste("Adj. R2 = ", round(summary(persite.richness.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  theme_classic()+
  labs(x = "Year", 
       y = "log10(per-site richness)")
persite.richness
```

#### ii. Density over time:

**Overall Density:**

Basic LM testing for trends in state-wide density: 

```{r}
statewide.dens.lm <- lm(log10(dens_xbar)~yr, statewide)
summary(statewide.dens.lm)
```

Significant increase in richness over time. 

Visualization:

```{r}
statewide.richness <- ggplot(statewide, aes(y = log10(dens_xbar), x = yr))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "darkgrey")+
  geom_text(aes(x = 2020, y = 4.4, label = paste("P = ", round(summary(statewide.dens.lm)$coefficients[2,4], 2), sep = "")), hjust = 1)+
  geom_text(aes(x = 2020, y = 4.35, label = paste("Adj. R2 = ", round(summary(statewide.dens.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  theme_classic()+
  labs(x = "Year", 
       y = "Density")
statewide.richness
```

**Per-site density:**

Basic LM testing for trends in state-wide per-site density: 

```{r}
persite.dens.lm <- lm(log10(dens_persite)~yr, statewide)
summary(persite.dens.lm)
```

Significant decrease in per-site density over time

Visualization:

```{r}
persite.dens <- ggplot(statewide, aes(y = log10(dens_persite), x = yr))+
  geom_point(size = 0.5)+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = "red")+
  geom_smooth(color = "darkgrey")+
  geom_text(aes(x = 2020, y = 3.5, label = paste("P = ", round(summary(persite.dens.lm)$coefficients[2,4], 5), sep = "")), hjust = 1)+
  geom_text(aes(x = 2020, y = 3.4, label = paste("Adj. R2 = ", round(summary(persite.dens.lm)$adj.r.squared, 2), sep = "")), hjust = 1)+
  theme_classic()+
  labs(x = "Year", 
       y = "log10(per-site density)")
persite.dens
```

## II. Checking taxa of interest

Taxa of interest/concern present in the dataset include: 

* *Pteronarcys californica*

* *Zapada* (esp. high elevation)

* SGCNs from Utah, Idaho, Wyoming, Colorado, Arizona, and Nevada


### A. *Pteronarcys californica*

First, extract all observations of *P. californica* into a new dataframe:

```{r}
p_cal <- taxa_densities%>%
  filter(scientificName == "Pteronarcys californica", 
         !splitCount == 0) #dropping samples where 0 individuals were counted
```

#### i. How is density changing over time across all sites? 

Visualization:

```{r}
ggplot(p_cal, aes(x = sampleDate, y = taxa_density))+
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5)+
  geom_smooth(se = F, method = "lm", color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "P. Californica Density (individuals/m2)")
```

Basic LM: 

```{r}
pcal.dens.lm <- lm(taxa_density~sampleDate, p_cal)
summary(pcal.dens.lm)
```

Non-significant decrease in *P. californica* density over time (ignoring effects of site, etc.)

#### ii. Is prevalence (proportion of sites w/ P. calif. per year) changing over time? 

Calculate # unique sites with *P. calif.* each year: 

```{r}
pCal_yrs <- p_cal%>%
  mutate(yr = year(sampleDate))%>% #create new column with year
  group_by(yr)%>% #group by year
  summarise(density_xbar = mean(taxa_density), #calculate mean density, # sites with P. Cal., and total abundance for each year
            n_sites = length(unique(siteId)), 
            tot_abund = sum(splitCount))
```

Add total sites each year and calculate % of sites w/ *P. cali.*: 

```{r}
# Calculate total sites per year:
sites <- taxa_densities%>%
  mutate(yr = year(sampleDate))%>% #Add year colum
  group_by(yr)%>% #group by year
  summarise(total_sites = length(unique(siteId))) #count # unique siteId's per year

#Merge with P cali data, calculate % sites with P. calif. each year: 

pCal_yrs <- merge(pCal_yrs, sites)%>%
  mutate(site_perc = (n_sites/total_sites)*100)
```


Visualization: 

```{r}
ggplot(pCal_yrs, aes(x = yr, y = site_perc))+
  geom_point()+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "Red")+
  geom_smooth(size = 0.5)+
  theme_classic()+
  labs(x = "Year", y = "% of sites with P. californica present")
```

Basic LM: 

```{r}
pcal.site.lm <- lm(site_perc~yr, pCal_yrs)
summary(pcal.site.lm)
```

No change in # sites with *P. californica* present over time. 

#### iii. Is total abundance changing over time? 

Visualization: 

```{r}
ggplot(pCal_yrs, aes(x = yr, y = tot_abund))+
  geom_point()+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "Red")+
  geom_smooth(size = 0.5)+
  theme_classic()+
  labs(x = "Year", y = "Total P. californica abundance")
```

No obvious trends in total abundance over time. 

#### iv. Is mean density changing over time? 

```{r}
ggplot(pCal_yrs, aes(x = yr, y = density_xbar))+
  geom_point()+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "Red")+
  geom_smooth(size = 0.5)+
  annotate(geom = "label", x = 2019, y = 80, label = "P = 0.035; R2 = 0.30")+
  theme_classic()+
  labs(x = "Year", y = "Average P. californica density (# individuals/m2)")
```

Basic LM: 

```{r}
pcal.dens.yr <- lm(density_xbar~yr, pCal_yrs)

summary(pcal.dens.yr)
```

Significant *decrease* in mean density over time - When averaged across all sites with *P. californica* observations, density (# individuals/m2) has decreased between 2000 and 2023. 

### B. *Zapada*

First, extract all observations of *Zapada* into a new dataframe:

```{r}
zapada <- taxa_densities%>%
  dplyr::filter(sampleDate > "1990-01-01")%>% #dropping observations before 1990
  dplyr::filter(genus == "Zapada", 
         !splitCount == 0) #dropping samples where 0 individuals were counted
```

Check Distribution: 

```{r}
ggplot(zapada, aes(x = log10(taxa_density)))+
  geom_histogram()
```

Strong left skew - use log transform. 

#### i. How is density changing over time across all sites? 


Visualization:

```{r}
ggplot(zapada, aes(x = sampleDate, y = log10(taxa_density)))+
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5)+
  geom_smooth(se = F, method = "lm", color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "log10(Zapada Density (individuals/m2))")
```

Basic LM: 

```{r}
zap.dens.lm <- lm(log10(taxa_density)~sampleDate, zapada)
summary(zap.dens.lm)
```

Significant *decrease* in *P. californica* density over time (ignoring effects of site, etc.)

#### ii. Is prevalence (% sites w/ Zapada per year) changing over time? 

Calculate # unique sites with *Zapada* each year:

```{r}
zapada_yrs <- zapada%>%
  mutate(yr = year(sampleDate))%>% #create new column with year
  group_by(yr)%>% #group by year
  summarise(density_xbar = mean(taxa_density), #calculate mean density, # sites with P. Cal., and total abundance for each year
            n_sites = length(unique(siteId)), 
            tot_abund = sum(splitCount))
```

Add total # sites per year and calculate %: 

```{r}
zapada_yrs <- merge(zapada_yrs, sites)%>%
  mutate(site_perc = (n_sites/total_sites)*100)
```


Visualization: 

```{r}
ggplot(zapada_yrs, aes(x = yr, y = site_perc))+
  geom_point()+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "Red")+
  geom_smooth(size = 0.5)+
  theme_classic()+
  labs(x = "Year", y = "Number of sites with Zapada present")
```

Basic LM: 

```{r}
zap.site.lm <- lm(site_perc~yr, zapada_yrs)
summary(zap.site.lm)
```

No change in % of sites with *Zapada* present over time.  

#### iii. Is total abundance changing over time? 

Visualization: 

```{r}
ggplot(zapada_yrs, aes(x = yr, y = tot_abund))+
  geom_point()+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "Red")+
  geom_smooth(size = 0.5)+
  theme_classic()+
  labs(x = "Year", y = "Total Zapada abundance")
```

Basic LM: 

```{r}
zap.abund.lm <- lm(tot_abund~yr, zapada_yrs)
summary(zap.abund.lm)
```

No change in Zapada abundance over time. 

#### iv. Is mean density changing over time? 

```{r}
ggplot(zapada_yrs, aes(x = yr, y = density_xbar))+
  geom_point()+
  geom_smooth(method = lm, se = F, size = 0.5, linetype = "dashed", color = "Red")+
  geom_smooth(size = 0.5)+
  annotate(geom = "label", x = 2019, y = 750, label = "P = 0.036, R2 = 0.15")+
  theme_classic()+
  labs(x = "Year", y = "Average Zapada density (# individuals/m2)")
```

Basic LM: 

```{r}
zap.dens.yr <- lm(density_xbar~yr, zapada_yrs)

summary(zap.dens.yr)
```

Significant *decrease* in mean density over time - When averaged across all sites with *Zapada* observations, density (# individuals/m2) has decreased between 2000 and 2023. 

#### v. Zapada above 3000m: 

First, select all sites with elevation >=3000m from zapada dataframe:

```{r}
zapada_hi <- zapada %>% 
  filter(elev_m >=3000)

length(unique(zapada_hi$siteId))
```

27 sites above 3000m - should be plenty to go with that rather than the 10 highest. 

Get site lat/long and elevation for each of these 27 sites:

```{r}
zap_hiSites <- zapada_hi %>%
  select(siteId, siteLongitude, siteLatitude,elev_m)%>% #select site and elevation cols
  distinct()

zap_hiSamples <-zapada_hi %>%
  select(sampleId, siteId, siteLongitude, siteLatitude, elev_m)%>%
  distinct()
```

Export site ID's, stream names, and sample ID's for all of these sites: 

```{r}
# Bring in site names from metadata file: 
site_names <- read.csv("raw_data/Utah_Sample_Data_Final_comids.csv")%>%
  select(sampleId, siteId, waterbodyName)

#merge with Zapada site info: 
zapHi_export <- merge(zap_hiSamples, site_names, all.y = F)%>%
  arrange(waterbodyName)%>%
  rename(elevationMeters = elev_m)

#save
write.csv(zapHi_export, "cleaned_data/high_zapada_info.csv")
```


Check distribution of density at these sites: 

```{r}
ggplot(zapada_hi, aes(x = log10(taxa_density)))+
  geom_histogram()
```

Strong left skew, use log transform. 

**Is density changing at these sites?** 

```{r}
ggplot(zapada_hi, aes(x = sampleDate, y = log10(taxa_density)))+
  geom_point(size = 0.5)+
  #geom_smooth(size = 0.5)+
  geom_smooth(se = F, method = "lm", color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "Zapada Density (individuals/m2)")
```

Possibly a decline in density over time. 

**Are there trends in prevalence, total abundance, or mean density over time?**

Calculate number of sites w/ high elevation Zapada per year, mean density and total abundance per year:

```{r}
zapHi_yrs <- zapada_hi%>%
  mutate(yr = year(sampleDate))%>% #create new column with year
  group_by(yr)%>% #group by year
  summarise(density_xbar = mean(taxa_density), #calculate mean density, # sites with P. Cal., and total abundance for each year
            n_sites = length(unique(siteId)), 
            tot_abund = sum(splitCount))
```

Add total sites each year and calculate % of sites w/ *Zapada*: 

```{r}
zapHi_yrs_pivot <- merge(zapHi_yrs, sites)%>% #merge with site numbers calculated above
  mutate(site_perc = (n_sites/total_sites)*100)%>% #calculate % sites w/ high elevation zapada
  pivot_longer(!yr, names_to = "measure", values_to = "value")%>% #pivot longer for plotting
  filter(!measure == "n_sites", !measure == "total_sites")
```

Visualization: 

```{r}
ggplot(zapHi_yrs_pivot, aes(x = yr, y = value, color = measure))+
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5)+
  geom_smooth(se = F, method = "lm", linetype = "dashed")+
  theme_classic()+
  facet_wrap(~measure, scales = "free")+
  labs(x = "Sample Date", y = "")+
  theme(legend.position = "none")
```

LM for density: 

```{r}
zapHi.dens.lm <- lm(density_xbar ~ yr, zapHi_yrs)
summary(zapHi.dens.lm)
```

Non-significant decline in density. 

#### vi. Map of the sites above 3000m:

First, get map data for Utah: 

```{r}
utah <- map_data("state", region = "utah") #state polygon
ut.counties <- map_data("county", region = "utah") #county polygons
```

Make map of Utah with the 10 highest Zapada sites marked: 

```{r}
zap.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = zap_hiSites, aes(x = siteLongitude, y = siteLatitude, color = elev_m, group = NULL), size = 4, pch = 20)+ #add zapada sites, color code by elevation. 
  labs(color = "Site elevation (m)", title = "Sites >3000m elevation with Zapada")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  scale_color_gradient(low = "#DCB0FC", high = "#7004BF")+ #setting color gradient for site colors
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, angle = 45, hjust = 1), 
        legend.position = "bottom", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5) 
        )
zap.map
```

Save this plot: 

```{r}
ggsave("plots/zapada_map.pdf", zap.map, device = "pdf", units = "in", width = 6.5, height = 4.5, dpi = "retina")
```

Plot of high elevation Zapada density over time: 

```{r}
zapHi.scatter <- ggplot(zapHi_yrs, aes(x = yr, y = density_xbar))+
  geom_point(size = 0.5)+
  geom_smooth(size = 0.5, linetype = "dashed")+
  geom_smooth(se = F, method = "lm", color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(x = "Sample Date", y = "High elevation Zapada density (individuals/m2)")+
  theme(axis.title = element_text(size = 10, face = "bold"), 
        axis.text = element_text(size = 9))+
  #ylim(0, 2000)+
  annotate(geom = "text", x = 2011, y = 2000, label = "P = 0.11; Adj. R2 = 0.14", size = 3.5, fontface = "bold")
zapHi.scatter
```

Stack with map and save: 

```{r}
zapHi.stack <- zap.map|zapHi.scatter
zapHi.stack
```

Save: 

```{r}
ggsave("plots/zapHi_trends.pdf", zapHi.stack, device = "pdf", units = "in", width = 11, height = 5, dpi = "retina")
```

### C.  SGCNs from Utah and surrounding states

Read in SGCN data (includes SGCNs from UT, ID, CO, NV, WY, AZ):

```{r}
sgcn <- read.csv("cleaned_data/sgcns.csv")%>%
  mutate(
         spp = word(scientificName, start = 2, end = 2), 
         g_abbrev = paste(substr(genus, 1, 1), ".", sep = ""),
        g_spp = paste(g_abbrev, spp, sep = " ")
         )%>%
  mutate(taxa_state = paste(g_spp, states, sep = " - "),)


sgcn_means <- sgcn %>%
  mutate(yr = year(sampleDate))%>%
  group_by(scientificName, yr)%>%
  summarise(density_xbar = mean(taxa_density))

unique(sgcn$states)
```

#### i. Map + density trends for UT SGCNs: 

Filter out UT SGCNs:

```{r}
ut <- sgcn %>%
  filter(str_detect(states, "UT") == T) #filter all rows that include UT in the "states" column
```

Map UT SGCNs, color coded by taxa: 

```{r}
utSGCN.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = ut, aes(x = siteLongitude, y = siteLatitude, color = g_spp, group = scientificName), size = 4, pch = 20)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", title = "Distribution of current Utah SGCNs")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "none", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
        )
utSGCN.map
```

Scatterplot showing trends in density of each species over time: 

First, calculate mean density for each taxa for each year: 

```{r}
ut_means <- ut %>%
  mutate(yr = year(sampleDate))%>% #create year column
  group_by(g_spp, yr)%>% #group by taxa and year
  summarise(density_xbar = mean(taxa_density), #calculate mean density
            tot_abund = sum(splitCount)) #and total abundance
```

```{r}
utSGCN.scatter <- ggplot(ut_means, aes(x = yr, y = density_xbar, color = g_spp))+
  geom_point()+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Mean taxa density (# individuals/m2)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 10, face = "italic"), 
        legend.position = "none"
        )+
  facet_wrap(~g_spp, scales = "free")
utSGCN.scatter
```

Are any of these trends significant? 

```{r}
ut_nested <- ut_means%>%
  nest(data = -g_spp)
```

Run a model for each taxa separately, return a summary table with model results for each taxa: 

```{r}
ut_models <- ut_nested %>%
  mutate(model = purrr::map(data, ~lm(density_xbar~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
ut_models
```

No significant trends (unsurprising, not much data). 

Add elevation figure: 

```{r}
utSGCN.elev <- ggplot(ut, aes(x = sampleDate, y = elev_m, color = scientificName))+
  geom_point()+
  theme_classic()+
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(x = "Sample Date", y = "Elevation (m)")
utSGCN.elev
```


Stack with map: 

```{r}
utSGCN.stack <- utSGCN.map|utSGCN.scatter
utSGCN.stack
```

Save: 

```{r}
ggsave("plots/utSGCN.pdf", utSGCN.stack, device = "pdf", units = "in", width = 11, height = 5, dpi = "retina")
```

#### ii. Map + density trends for SGCNs from all other states

Drop UT SGCNs, keep all others:

```{r}
other_states <- sgcn %>%
  filter(!(str_detect(states, "UT") == T))%>% #drop all rows that include UT in the "states" column
  mutate(taxa_state = paste(g_spp, states, sep = " - "))
```

Make a map of all SGCN's from other states - color code by taxa, different shapes for each state: 

```{r}
adjSGCN.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = other_states, aes(x = siteLongitude, y = siteLatitude, color = taxa_state, shape = states), size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "State", title = "Distribution of SGCNs from neighboring states")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "bottom", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
        )
adjSGCN.map
```

Make plots of density over time - first, calculate mean density for each taxa*yr

```{r}
other_means <- other_states %>%
  mutate(yr = year(sampleDate))%>% #add year column
  group_by(taxa_state, yr)%>% #group by taxa and year
  summarise(density_xbar = mean(taxa_density),  #calculate density
            tot_abund = sum(splitCount), #calculate total abundance
            scientificName = unique(scientificName),
            states = unique(states)) #retain states column

 #get rid of taxa w/ only 1 year of data: 
oneyr <- other_means %>% #create new obj
  group_by(taxa_state)%>%  #group by taxa
  summarise(n_yrs = length(unique(yr)) 
            ,scientificName = unique(scientificName)
            )%>% #count # years for that taxa
  filter(n_yrs == 1) #extract rows with only 1 observation

other_multiyear <- other_means %>%
  filter(!taxa_state%in%oneyr$taxa_state) #drop taxa with only 1 year of data
```

Create plot: 

```{r}
adjSGCN.scatter <- ggplot(other_multiyear, aes(x = yr, y = density_xbar, color = taxa_state, shape = states))+
  geom_point()+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed")+
  theme_classic()+
  labs(x = "Year", y = "Mean taxa density (# individuals/m2)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
  facet_wrap(~taxa_state, scales = "free")
adjSGCN.scatter
```

Stack and save: 

```{r}
adjSGCN.stack <- adjSGCN.map|adjSGCN.scatter
adjSGCN.stack

ggsave("plots/adjacentSGCN.pdf", adjSGCN.stack, device = "pdf", units = "in", width = 12, height =6, dpi = "retina")
```

Are any of these trends statistically significant? 

Basic LM of density ~ year for each taxa: 

Nest data by taxa: 

```{r}
sgcn_nested <- other_multiyear%>%
  nest(data = -taxa_state)
```

Run a model for each taxa separately, return a summary table with model results for each taxa: 

```{r}
sgcn_models <- sgcn_nested %>%
  mutate(model = purrr::map(data, ~lm(density_xbar~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
sgcn_models
```

Significant decline in *P. californica*, weakly significant increase in *H. azteca*. 

Overview map:

```{r}

AllSGCN.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = sgcn, aes(x = siteLongitude, y = siteLatitude, color = taxa_state, shape = states), size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "State", title = "Distribution of SGCNs from Utah & neighboring states")+ #updating legend title
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "bottom", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
        )+
  scale_shape_manual(values = c(16, 17, 15, 3, 7, 18, 8))+
  scale_color_manual(values = hue_pal()(20))
AllSGCN.map
```

Save: 

```{r}
ggsave("plots/sgcn_plots/sgcn_overview.pdf", AllSGCN.map, device = "pdf", units = "in", height = 9, width = 6.5, dpi = "retina")
```

#### iii. Map + density + elevation for each SGCN taxa

Goal is to produce a map + density plot + elevation plot for each SGCN in the dataset. Including SGCNs from all states, there are 18 total: 

```{r}
sort(unique(sgcn$scientificName))
```

Omitting Taxa with only one year of data: 

```{r}
sgcn_multiyear <- filter(sgcn, !scientificName%in%oneyr$scientificName)
sort(unique(sgcn_multiyear$scientificName))
``` 

For each SGCN taxa, want to produce a map of that taxa's distribution in Utah next to stacked plots showing the taxa density over time and site elevations over time. 

First, add color and shape palates to keep color/shape scheme the same as the overview map: 

```{r}
taxa_colors <- sgcn %>%
  select(scientificName, states)%>% 
  distinct()%>%
  mutate(taxa_color = hue_pal()(20)) #creating dataframe with column containing hex codes for each of the 18 colors used for each taxa in the overview map

state_shapes <- sgcn %>%
  select(states)%>%
  distinct()%>%
  mutate(state_shape = c(16, 17, 15, 3, 7, 18, 8)) #creating dataframe with column with the shape code used for each different state in the overview map

taxa_state_pals <- merge(taxa_colors, state_shapes) #merging these DF's to get new dataframe with taxa names, colors, and state shape codes


sgcn_plot <- merge(sgcn, taxa_state_pals) #merge this DF with the SGCN data to add shape codes and taxa colors to the entire dataset
```

Plotting for each taxa using a for loop: 

```{r}
sgcn.names <- c(sort(unique(sgcn_multiyear$scientificName))) #make a list of all SGCNs with multiple years of data
plot.list <- list() #initialize empty list for storing plots

for(i in 1:length(sgcn.names)){ #Open for loop, iterate over each taxa name in the sgcn.names list
  dat <- filter(sgcn_plot, scientificName == sgcn.names[i]) #Create temporary dataframe with data for the "ith" taxa, then plot using that data:
  
#Map  
  m <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = dat, aes(x = siteLongitude, y = siteLatitude, color = taxa_color, shape = factor(state_shape)), color = dat$taxa_color, pch = dat$state_shape, size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "State", #updating legend title
       title = paste("Distribution of", unique(dat$scientificName), "in Utah", sep = " ") #adding plot title using taxa name
       )+ 
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "none", 
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5)
        )
  
  #Density: 
d <- ggplot(filter(sgcn_means, scientificName == sgcn.names[i]), aes(x = yr, y = density_xbar))+
  geom_point(color = unique(dat$taxa_color), pch = unique(dat$state_shape))+
  geom_smooth(se = F, method = "lm", size = 0.5, linetype = "dashed", color = unique(dat$taxa_color))+
  theme_classic()+
  labs(x = "Year", y = "Mean taxa density", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
   annotation_custom(grid::textGrob( #adding custom annotation to plot to add P value for density ~ year
     paste("P = ", round(summary(lm(density_xbar~yr, filter(sgcn_means, scientificName == sgcn.names[i])))$coefficients[,4][2], 3), sep = ""), #label = pasting "P =" and the P value from a simple lm of density ~ year
                                    0.9, 0.9, #adjusting label position (relative to plot area)
     gp = grid::gpar(fontsize = 10))) #adjusting font size

#Elevation
e <- ggplot(filter(sgcn, scientificName == sgcn.names[i]), aes(x = year(sampleDate), y = elev_m))+
  geom_point(color = unique(dat$taxa_color), pch = unique(dat$state_shape))+
  theme_classic()+
  labs(x = "Year", y = "Sample Elevation (m)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
  scale_y_continuous(limits = c(min(sgcn$elev_m), max(sgcn$elev_m))) #setting y limits = to min and max elevations in the dataset so that all plots will be on the same scale

#combine all three plots: map next to density stacked above elevation
comb <- m|(d/e)

plot.list[[i]]<-comb #save plot as "ith" object in plot.list

fp <- paste("plots/sgcn_plots/", sgcn.names[i], ".pdf", sep = "") #generate filepath for saving pdf

ggsave(fp, comb, device = "pdf", units = "in", height = 4.5, width = 8, dpi = "retina") #save pdf of combined plot
print(paste("completed", sgcn.names[i], sep = " ")) #return taxa name for tracking while code is running
}

```

To check individual plots - call plot.list[[#]] - e.g: 

```{r}
plot.list[[3]]
```

Final plots: Map of species with only 1 yr of data + elevations for those taxa: 

```{r}
#Data Setup: 
sgcn_oneyr <- sgcn_plot %>%
  filter(scientificName%in%oneyr$scientificName)

#Map: 
oneyr.map <- ggmap(get_map(c(-111.950684,39.419220), source = "stamen", zoom = 7, maptype = "terrain-background"))+ #basemap: terrain background (no labels) from google maps platform console, centered on UT centroid
  geom_polygon(data = ut.counties, aes(x = long, y = lat, group = group), color = "black", fill = "white", size = 0.5, alpha = 0.0, linetype = "dotted")+ #add counties to map, use dotted lines
  geom_polygon(data = utah, aes(x = long, y = lat, group = group), color = "black", fill = "white", alpha = 0.0)+ #add state outline to map, use solid line
  geom_point(data = sgcn_oneyr, aes(x = siteLongitude, y = siteLatitude, color = scientificName, shape = factor(state_shape)), size = 3)+ #add sites w/SGCNs; color code by taxa
  labs(color = "Taxa", shape = "Listing State(s)", #updating legend title
       title = "Additional SGCNs with <2yrs data" #adding plot title using taxa name
       )+ 
  annotate(geom = "text", x = -111.8, y = 39, label = "Utah", size = 6, fontface = 4, color = "black", alpha = 0.75)+ #add "Utah" label to center of map
  theme_void()+ #removing lat/long from x and y axes 
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        legend.text = element_text(size = 10, face = "italic"), 
        legend.position = "right", 
        plot.title = element_text(size = 10, face = "bold", hjust = 0.5)
        )+
  scale_color_manual(values = unique(sgcn_oneyr$taxa_color), labels = unique(sgcn_oneyr$scientificName))+
  scale_shape_manual(values = unique(sgcn_oneyr$state_shape), labels = unique(sgcn_oneyr$states))


#Elevations: 
oneyr.elev <- ggplot(sgcn_oneyr, aes(x = year(sampleDate), y = elev_m, color = scientificName, shape = states))+
  geom_point(size = 3)+
  theme_classic()+
  labs(x = "Year", y = "Sample Elevation (m)", color = "Taxa Name")+
  theme(legend.title = element_text(size = 10, face = "bold"), #adjusting legend title/text/plot title size, face, and position
        strip.text = element_text(size = 8, face = "italic"), 
        legend.position = "none"
        )+
  scale_color_manual(values = unique(sgcn_oneyr$taxa_color), labels = unique(sgcn_oneyr$scientificName))+
  scale_shape_manual(values = unique(sgcn_oneyr$state_shape), labels = unique(sgcn_oneyr$states))+
  scale_y_continuous(limits = c(min(sgcn$elev_m), max(sgcn$elev_m))) #setting y limits = to min and max elevations in the dataset so that all plots will be on the same scale

#Stack:
oneyr.comb <- oneyr.map|oneyr.elev
oneyr.comb

#Save:
ggsave("plots/sgcn_plots/sgcns_oneYr.pdf", oneyr.comb, device = "pdf", units = "in", height = 4.5, width = 8, dpi = "retina") #save pdf of combined plot


```


## III. Effects of sampling design (lab split, field split, area sampled) on total sample density

First, need to calculate total density in each sample: 

```{r}
total_dens <- taxa_densities%>%
  group_by(sampleId)%>% # group by sample ID
  summarise(labSplit = mean(labSplit), #Add sample lab split, field split, and area
            fieldSplit = mean(fieldSplit), 
            tot_dens = sum(taxa_density), # calculate total density in sample
            area = mean(area))%>%
  mutate(sample_prop = labSplit*fieldSplit) #calculate sample proportion (labSplit*fieldSplit)
```

### A. Density vs. LabSplit: 

Basic plot:

```{r}
dens.labsplit <- ggplot(filter(total_dens, !labSplit == 1), aes(x = labSplit, y = tot_dens))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(y = "Total Sample Density", x = "")
dens.labsplit
```


Log transformed plot: 

```{r}
dens.labsplit.log <- ggplot(total_dens, aes(x = labSplit, y = log10(tot_dens)))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed", method = "lm")+
  annotate(geom = "label", x = 0.5, y = 0.2, label = "P <0.001; R2 = 0.55")+
  theme_classic()+
  labs(y = "log10(Total Sample Density)", x = "Lab Split Proportion")
dens.labsplit.log
```

Basic LM: 

```{r}
dens.ls.lm <- lm(log10(tot_dens)~labSplit, filter(total_dens, labSplit >=0.25, !labSplit == 1))
summary(dens.ls.lm)
```

Significant negative relationship between lab split and total sample density. 



### B. Density vs. Sample Proportion (lab split * field split): 

Basic plot:

```{r}
dens.sampleprop <- ggplot(total_dens, aes(x = sample_prop, y = tot_dens))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(y = "", x = "")
dens.sampleprop
```


Log transformed plot: 

```{r}
dens.sampleprop.log <- ggplot(total_dens, aes(x = sample_prop, y = log10(tot_dens)))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed", method = "lm")+
  annotate(geom = "label", x = 0.5, y = 0.2, label = "P <0.001; R2 = 0.55")+
  theme_classic()+
  labs(y = "", x = "Sample Proportion")
dens.sampleprop.log
```

Basic LM: 

```{r}
dens.sp.lm <- lm(log10(tot_dens)~sample_prop, total_dens)
summary(dens.sp.lm)
```

Significant negative relationship between sample proportion and total sample density. 


### C. Sample Area

Basic plot:

```{r}
dens.area <- ggplot(filter(total_dens, area <50), aes(x = area, y = tot_dens))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed")+
  theme_classic()+
  labs(y = "", x = "")
dens.area
```

Log transformed plot: 

```{r}
dens.area.log <- ggplot(filter(total_dens, area <50), aes(x = area, y = log10(tot_dens)))+
  geom_point(size = 0.5, alpha = 0.5)+
  geom_smooth(size = 0.5, color = "Red", linetype = "dashed", method = "lm")+
  annotate(geom = "label", x = 1.75, y = 0.1, label = "P <0.001; R2 = 0.10")+
  theme_classic()+
  labs(y = "", x = "Sample area, m2")
dens.area.log
```

Basic LM: 

```{r}
dens.ar.lm <- lm(log10(tot_dens)~area, filter(total_dens, area <50))
summary(dens.ar.lm)
```

Significant negative relationship between sample proportion and total sample density. 



### D. Create summary figure of all three:

```{r, message = F, warning = F}
dens.samplemethod <- (dens.labsplit/dens.labsplit.log)|(dens.sampleprop/dens.sampleprop.log)|(dens.area/dens.area.log)
dens.samplemethod
```

Save:

```{r}
ggsave("plots/dens_samplemethod.pdf", dens.samplemethod, device = "pdf", units = "in", height = 6.5, width = 9, dpi = "retina")
```

##### **Summary:**

log10(Density) has a significant negative correlation with lab split, sample proportion (lab split * field split), and area. The R2 for lab split and sample proportion are fairly hight (0.55), while the R2 for area is very low (0.1). 

## IV. Ecoregion-level analyses

Read in ecoregion density/richness info:

```{r}
eco_r_d <- read.csv("cleaned_data/eco_richness_density.csv")
```

### A. Are there trends in richness over time within each ecoregion

Check distribution: 

```{r}
ggplot(eco_r_d, aes(x = log10(richness_perSample)))+
  geom_histogram()
```

Strong left skew; use log transform


**Nested LM for richness (per site) ~ year:** 

Nest data by ecoregion: 

```{r}
eco_nested <- eco_r_d%>%
  nest(data = -ecoName)
```

Run a model for each taxa separately, return a summary table with model results for each taxa: 

```{r}
ecoRichness_models <- eco_nested %>%
  mutate(model = purrr::map(data, ~lm(log10(richness_perSample)~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
ecoRichness_models
```

Significant increase in richness in Wasatch & Uinta 

Visualization: 

```{r}
library(ggpp)
p.vals <- ecoRichness_models %>%
  select(ecoName, p.value)

eco_r_pvals <- merge(eco_r_d, p.vals)

eco.richness <- ggplot(eco_r_pvals, aes(x = yr, y = log10(richness_perSample), color = ecoName))+
  geom_point()+
  geom_smooth(method = "lm", se = F)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  theme_classic()+
  facet_wrap(~ecoName, scales = "free_x", nrow = 2, ncol = 4)+
  labs(x = "Year", y = "log10(Per-sample richness)", color = "Ecoregion Name")+
  theme(legend.position = "none", 
        axis.title = element_text(size = 10, face = "bold"), 
        strip.text = element_text(size = 8))
eco.richness
```

Save: 

```{r}
ggsave("plots/ecoregion_richness.pdf", eco.richness, device = "pdf", units = "in", width = 8, height = 5, dpi = "retina")
```

### B. Are there trends in density over time within each ecoregion

Check distribution: 

```{r}
ggplot(eco_r_d, aes(x = log10(density_perSample)))+
  geom_histogram()
```

Strong left skew; use log transform


**Nested LM for richness (per site) ~ year:** 


Run a model for each ecoregion separately, return a summary table with model results for each ecoregion: 

```{r}
ecoDens_models <- eco_nested %>%
  mutate(model = purrr::map(data, ~lm(log10(density_perSample)~yr, data = .)%>%
                       tidy))%>%
  unnest(model)%>%
  filter(term == "yr")
ecoDens_models
```

Significant decrease in CO Plateaus. No change in Central Basin & Range or Wasatch 

Visualization: 

```{r}
library(ggpp)
rp.vals <- ecoDens_models %>%
  select(ecoName, p.value)

eco_d_pvals <- merge(eco_r_d, rp.vals)

eco.density <- ggplot(eco_d_pvals, aes(x = yr, y = log10(density_perSample), color = ecoName))+
  geom_point()+
  geom_smooth(method = "lm", se = F)+
  geom_text_npc(aes(npcx = 0.9, npcy = 0.1, label = paste( "P = ",round(p.value, 2), sep = "")))+
  theme_classic()+
  facet_wrap(~ecoName, scales = "free_x", nrow = 2, ncol = 4)+
  labs(x = "Year", y = "log10(Per-sample density)", color = "Ecoregion Name")+
  theme(legend.position = "none", 
        axis.title = element_text(size = 10, face = "bold"), 
        strip.text = element_text(size = 8))
eco.density
```

Save: 

```{r}
ggsave("plots/ecoregion_density.pdf", eco.density, device = "pdf", units = "in", width = 8, height = 5, dpi = "retina")
```



